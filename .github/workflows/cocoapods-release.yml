name: Release to CocoaPods

on:
  release:
    types:
      - published

permissions:
  contents: write

env:
  PODSPEC_PATH: ./TempoSDK.podspec

jobs:
  validate-update-podspec:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.REPO_WRITE_PAT }}

      # Update the semantic version number in the .TempoSDK.podspec file
      - name: Update Version
        shell: pwsh
        run: |
          $version = "'${{ github.event.release.tag_name }}'"
          Write-Output "Attempting to update podspec version to $version"
          
          $podspec = Get-Content "$env:PODSPEC_PATH"
          $podspec = $podspec -replace '^(.*spec.version.*)(''.*'')$', "`$1$version"
          
          Write-Output "Adjusted podspec:`n$podspec"
          
          $podspec | Set-Content -Path "$env:PODSPEC_PATH" -Force

      # Stage and commit the updated .podspec file
      - name: Stage & Commit
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit ${{ env.PODSPEC_PATH }} -m "Updated podspec version"

      # Push the updated podspec file
      - name: Push Changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.REPO_WRITE_PAT }}
          force_with_lease: true

  push-pod:
    needs: validate-update-podspec
    runs-on: macos-latest
    environment: production

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Using the podspec, push the latest version of the pod to CocoaPod
      - name: Push Pod
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        run: |
          pod trunk push ${{ env.PODSPEC_PATH }} --allow-warnings --verbose
